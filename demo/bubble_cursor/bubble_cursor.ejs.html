<!DOCTYPE html>
<html lang="en">
	<head>
		<title>cjs</title>
		<%- include(cjs_inc.main) %>
		<script type="text/javascript" src="raphael-min.js"></script>
		<script type="text/javascript" src="../jquery.js"></script>
		<script type="text/javascript">
			var moving = true;
			$(function() {
				var paper = Raphael("canvas", 640, 480);

				var cursor_x = cjs(0);
				var cursor_y = cjs(0);
				$("#canvas").mousemove(function(event) {
					cursor_x.set(event.offsetX);
					cursor_y.set(event.offsetY);
				});

				var max_bubble_select_distance = cjs(100); // negative for no limit

				var create_bubble = function() {
					var margin = 30;
					var cx = cjs(Math.random()*(640-2*margin) + margin);
					var cy = cjs(Math.random()*(480-2*margin) + margin);
					var start_time = cjs.time.get();
 
					var rv = {
						x: cjs(function() {
							return cx.get() + rv.movement_radius.get() * Math.cos(rv.movement_velocity.get() * (cjs.time.get() - start_time));
						})
						, y: cjs(function() {
							return cy.get() + rv.movement_radius.get() * Math.sin(rv.movement_velocity.get() * (cjs.time.get() - start_time));
						})
						, r: cjs(Math.random() * 30 + 20)
						, state: cjs.fsm()
									.add_state("idle")
									.add_state("closest")
									.add_transition(cjs.on("mousedown", window), "pressed")
									.add_state("pressed")
									.add_transition(cjs.on("mouseup", window), "closest")
						, movement_velocity: cjs(moving ? Math.random() / 1000 : 0)
						, movement_radius: cjs(moving ? Math.random() * 100 - 50 : 0)
					};

					return rv;
				};

				var targets = cjs([
					create_bubble()
					, create_bubble()
					, create_bubble()
					, create_bubble()
					, create_bubble()
					, create_bubble()
					, create_bubble()
					, create_bubble()
				]);

				var target_distances = cjs(function() {
					return targets.get().map(function(target) {
						var dx = cursor_x.get() - target.x.get();
						var dy = cursor_y.get() - target.y.get();

						return Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2)) - target.r.get();
					});
				});
				var closest_target_index = cjs(function() {
					var distances = target_distances.get();

					var max_distance= max_bubble_select_distance.get();

					var min_distance_index = -1;
					var min_distance = false;
					for(var i = 0; i<distances.length; i++) {
						var distance = distances[i];
						if(min_distance === false || distance < min_distance) {
							min_distance_index = i;
							min_distance = distance;
						}
					}

					if(min_distance_index < 0) {
						return -1;
					} else {
						if(max_distance < 0 || min_distance <= max_distance) {
							return min_distance_index;
						} else {
							return -1;
						}
					}
				});

				var closest_target = cjs(function() {
					var cti = closest_target_index.get();
					if(cti < 0) { return null; }
					return targets.get()[cti];
				});

				var select_cursor_radius = cjs(function() {
					var ct = closest_target.get();
					if(ct === null) {
						return 0;
					} else {
						var dx = cursor_x.get() - ct.x.get();
						var dy = cursor_y.get() - ct.y.get();
						var distance = Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2));
						return Math.max(0.001, distance - ct.r.get());
					}
				});

				var target_displays = targets.map(function(target) {
					var circle = paper.circle(target.x.get(), target.y.get(), target.r.get());
					circle.attr("fill", "#222");
					circle.attr("stroke", "#777");
					target.circle = circle;

					target.state.on("idle", function() {
						circle.attr("fill", "#222");
					});
					target.state.on("closest", function() {
						circle.attr("fill", "#FFF");
					});
					target.state.on("pressed", function() {
						circle.attr("fill", "#0F0");
					});
					target.x.onChange(function(val) {
						circle.attr("cx", val);
					}, 5);
					target.y.onChange(function(val) {
						circle.attr("cy", val);
					}, 5);
					return circle;
				}, function(target, index, circle) {
					circle.remove();
				});

				var cursor = paper.circle(0, 0, 10);
				var select_cursor = paper.circle(0, 0, 0);

				cursor.attr("fill", "#f00");
				select_cursor.attr("stroke", "#FFF");
				select_cursor.attr("stroke-dasharray", "- ");


				cursor_x.onChange(function(val) {
					select_cursor.attr("cx", val);
					cursor.attr("cx", val);
				}, 5);
				cursor_y.onChange(function(val) {
					select_cursor.attr("cy", val);
					cursor.attr("cy", val);
				}, 5);
				select_cursor_radius.onChange(function(val) {
					if(val === 0) {
						select_cursor.attr("stroke", "#777");
						select_cursor.attr("r", max_bubble_select_distance.get());
					} else {
						select_cursor.attr("stroke", "#FFF");
						select_cursor.attr("r", val);
					}
				}, 5);
				closest_target.onChange(function(val, old_val) {
					if(val !== null) {
						val.state.set_state("closest");
					}
					if(old_val !== null) {
						old_val.state.set_state("idle");
					}
				}, 5);
				cursor_x.get();
				cursor_y.get();
				select_cursor_radius.get();
				closest_target.get();
			});
		</script>
		<style type="text/css">
			body {
				background: #333;
				color: #fff;
				font: 300 100.1% "Helvetica Neue", Helvetica, "Arial Unicode MS", Arial, sans-serif;
				margin: 100px;
			}
			#canvas {
				width: 640px;
				margin: auto;
				border: 1px solid black;
			}
		</style>
	</head>
	<body><div id="canvas"></div></body>
</html>
