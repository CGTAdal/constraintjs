<!DOCTYPE html>
<html lang="en">
  <head>
    <title>cjs</title>
	<script type="text/javascript">
		var files = {
			"file1.txt": ""
			, "file2.txt": ""
			, "file3.txt": ""
			, "file4.txt": ""
			, "file5.txt": ""
			, "file6.txt": ""
			, "file7.txt": ""
			, "file8.txt": ""
			, "dir1": {
				"file1.txt": ""
				, "file2.txt": ""
			}
			, "dir2": {
				"file1.txt": ""
				, "dir3": {}
			}
		};
		var do_get_file = function(path) {
			var folders = path.split("/");
			var curr_dir = files;
			for(var i = 0; i<folders.length; i++) {
				var folder = folders[i];
				if(folder === "." || folder === "") {
					continue;
				} else {
					if(curr_dir.hasOwnProperty(folder)) {
						curr_dir = curr_dir[folder];
					} else {
						return null;
					}
				}
			}
			return curr_dir;
		};
		var do_list_files = function(path) {
			var curr_dir = do_get_file(path);

			var rv = [];
			cjs._.forEach(curr_dir, function(file, filename) {
				rv.push(filename);
			});
			return rv;
		};
		var do_get_file_type = function(path) {
			var file = do_get_file(path);
			if(file === null) { return null; }
			else if(typeof file === "string") { return "file"; }
			else { return "directory"; }
		};

		var get_delay = function(minimum, variance) {
			return minimum + Math.random() * variance;
		};
		var fail_with_probability = function(prob) {
			return Math.random() < prob;
		};

		var list_files = function(path, on_success, on_fail) {
			var delay = get_delay(100, 200);
			window.setTimeout(function() {
				if(fail_with_probability(0.1)) {
					on_fail("Random error");
				} else {
					on_success(do_list_files(path));
				}
			}, delay);
		};


		var get_file_type = function(path, on_success, on_fail) {
			var delay = get_delay(100, 200);
			window.setTimeout(function() {
				if(fail_with_probability(0.2)) {
					on_fail("Random error");
				} else {
					on_success(do_get_file_type(path));
				}
			}, delay);
		};
	</script>
	<%- cjs_include(cjs_inc.main) %>
	<script type="text/javascript">

		var _ = cjs._;
		window.onload = function() {
			var path = cjs("/");
			var filenames = cjs.async_$(function(on_success, on_fail) {
						list_files(path.get(), on_success, on_fail);
					});
			var filetypes = filenames.map(function(filename) {
					var filetype = cjs.async_$(function(on_success, on_fail) {
							get_file_type(path.get() + "/" + filename, on_success, on_fail);
						});
					return filetype;
				});
			//ft1 = cjs("file");
			//ft1.state = cjs.fsm().add_state("resolved");

			//filetypes = cjs([ft1]);


			window.filenames = filenames;
			window.filetypes = filetypes;
			var template;
			template = cjs.template("#filelist");
			/*
			template = function(obj) {
					with (obj) {
						return cjs.create('dom_element', 'span', {} // (root)
							, cjs.create('fsm_constraint', files.state, { // {{#diagram files.item('state')}}
								'pending': [
									cjs.create('dom_text', 'Loading...') // (text /)
								], 'resolved': [
									files.map(function(filename, index) { // {{#each files}}
										return [ // {{#each}}
											cjs.create('fsm_constraint', filetypes.item(index).item('state'), { // {{#diagram filetypes.item(index).item('state')}}
												'pending': [
													cjs.create('dom_element', 'div', { // <div>
															'class': cjs.concat('loading')
														} 
														, cjs.create('dom_text', '...') // (text /)
													) // </div>
												], 'resolved': [
													, cjs.create('dom_element', 'div', { // <div>
															'class': cjs.concat('resolved')
														} 
														, cjs.create('dom_text', filename) // {{filename}}
														, cjs.create('dom_text', ' ') // (text /)
														, cjs.create('dom_text', filetypes.item(index)) // {{filetypes[index]}}
													) // </div>
												], 'rejected': [
													cjs.create('dom_element', 'div', { // <div>
															'class': cjs.concat('error')
														} 
														, cjs.create('dom_text', 'error') // (text /)
													) // </div>
												]
											}) // {/diagram}
										];
									}) // {{/each}}
								], 'rejected': [
									cjs.create('dom_text', 'Error') // (text /)
								]
							}) // {/diagram}
							); // (/root)
							}
					};
			/*
			template = function (obj) {
							with(obj) {
							return cjs.create('dom_element', 'span', {} // (root)
							, cjs.create('fsm_constraint', files.state, { // {{#diagram files.state}}

							'pending': [
								cjs.create('dom_text', 'Loading...') // (text /)
							], 'resolved': [
							files.map(function(filename, index) { // {{#each files}}
							return [ // {{#each}}
								(function() {
									with(cjs.constraint.item(filetypes, cjs.get(index))) { // {{#with filetypes[index]}}
										var filetype = cjs.constraint.item(filetypes, cjs.get(index));
										var state = cjs.constraint.item(filetypes, cjs.get(index), "state");
										return [
											cjs.create('fsm_constraint', cjs.constraint.item(filetype, "state"), { // {{#diagram filetype.state}}

											'pending': [
												cjs.create('dom_element', 'div', {'class': 'loading'}, cjs.create('dom_text', '...'))
											], 'resolved': [
												cjs.create('dom_element', 'div', {'class': 'resolved'} 
													, cjs.create('dom_text', filename) // {{filename /}}
													, cjs.create('dom_text', ' ') // (text /)
													, cjs.create('dom_text', filetype) // {{filetype /}}
													) // </div>
											], 'rejected': [
												cjs.create('dom_element', 'div', { 'class': 'error'}, cjs.create('dom_text', 'error')) // </div>
											]}) // {/diagram}
											];
									}
								}()) // {{/with}}
								];}) // {{/each}}
								]
							, 'rejected': [
								cjs.create('dom_text', 'Error') // (text /)
							]}) // {/diagram}
							); // (/root)
							}
							};
			/**/
		//	console.log(template);
			var files_dom = document.getElementById("files");
		//	files_dom.appendChild(template({files: filenames, filetypes: filetypes}));
		};
	</script>
	<style type="text/css">
		#files {
			min-height: 130px;
		}
		#files.loading {
			background-image: url('loading.gif');
			background-repeat: no-repeat;
		}

		.resolved {
			background-color: green;
		}

		.loading {
			background-color: yellow;
		}
		.error {
			background-color: red;
		}

	</style>
	<script id="filelist" type="cjs/template">
	{{#diagram files.state}}
		{{#state pending}}Loading...{{/state}}
		{{#state resolved}}
			{{#each files filename index}}
				{{#diagram filetypes[index].state}}
					{{#state pending}}
						<div class='loading'>...</div>
					{{/state}}
					{{#state resolved}}
						<div class='resolved'>{{filename}} {{filetypes[index]}}</div>
					{{/state}}
					{{#state rejected}}
						<div class='error'>error</div>
					{{/state}}
				{{/diagram}}
			{{/each}}
		{{/state}}
		{{#state rejected}}Error{{/state}}
	{{/diagram}}
	</script>
  </head>
  <body>
	  <div id="files" />
  </body>
</html>
