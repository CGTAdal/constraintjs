<!DOCTYPE html>
<html lang="en">
  <head>
    <title>cjs</title>
	<script type="text/javascript" src="jquery.js"></script>
	<script type="text/javascript" src="underscore-min.js"></script>
	<script type="text/javascript">
		var get_files = function(path, on_success, on_fail) {
			$.ajax({
				url: "list_files"
				, data: {
					path: path
				}
				, success: function(data) {
					data = JSON.parse(data);
					if(data.errno) {
						on_fail(data);
					} else {
						on_success(data);
					}
				}
				, error: function(err) {
					on_fail(err);
				}
			});
		};
		var get_file_type = function(path, on_success, on_fail) {
			$.ajax({
				url: "file_type"
				, data: {
					path: path
				}
				, success: function(data) {
					if(data.errno) {
						on_fail(data);
					} else {
						on_success(data);
					}
				}
				, error: function(err) {
					on_fail(err);
				}
			});
		};
	</script>
	<%- include(cjs_inc.main) %>
	<script type="text/javascript">
		var timeout = 2000;
		var read_files = function (path, successCallback, errorCallback) {
			var rootPath = path;
			get_files(rootPath, function (files) {
				var i, entries = [], d, deferreds = [];

				// This function is used to create individual functions for each deferred. 
				// These generated functions will add the async result to the right place 
				// in the entries array.
				var genAddToEntriesArrayFunction = function (index) {
					return function (value) { entries[index] = value; };
				};

				// This function is called to initiate the stat on individual entires.
				// Takes the item's full path and the deferred to resolve with.
				var statEntry = function (itemFullPath, filename, deferred) {
					get_file_type(itemFullPath, function (type) {
						if (type === "directory") {
							deferred.resolve({type:"directory", path:itemFullPath, name: filename});
						} else if (type === "file") {
							deferred.resolve({type:"file", path:itemFullPath, name: filename});
						} else { // Whatever was returned is neither a file nor a dir, so don't include it.
							deferred.resolve(null);
						}
					}, function(err) {
						deferred.reject({errno: 1});
					});
				};
				
				// Create all the deferreds, and start the work executing!
				for (i = 0; i < files.length; i++) {
					d = new $.Deferred();
					d.done(genAddToEntriesArrayFunction(i));
					deferreds.push(d);
					statEntry(rootPath + "/" + files[i], files[i], d);
				}

				// FIXME: (joelrbrandt or pflynn) -- once we have an async library, it would be good
				// to replace the code below with a library call.
				
				// Get a Promise that depennds on all the individual deferreds finishing.
				var masterPromise = $.when.apply(this, deferreds);
				
				// We want the error callback to get called after some timeout (in case some deferreds don't return).
				// So, we need to wrap masterPromise in another deferred that has this timeout functionality    
				var timeoutWrapper = new $.Deferred();

				var timer = setTimeout(function () {
					// SECURITY_ERR is the HTML5 File catch-all error, and there isn't anything
					// more fitting for a timeout.
					timeoutWrapper.reject({errno: 2});
				}, timeout);

				masterPromise.always(function () {
					clearTimeout(timer); // clear timeout if the masterPromise finishes (with success or error)
				});
				
				// When masterPromise finishes, we want the result to bubble up to timeoutWrapper
				masterPromise.pipe(timeoutWrapper.resolve, timeoutWrapper.reject);
				
				// Add the callbacks to the top-level Promise. The top-level Promise is timeoutWrapper,
				// which wraps masterPromise, which in turn wraps all the individual deferred objects.
				timeoutWrapper.then(
					function () { // success
						// The entries array may have null values if stat returned things that were
						// neither a file nor a dir. So, we need to clean those out.
						var cleanedEntries = [], i;
						for (i = 0; i < entries.length; i++) {
							if (entries[i]) {
								cleanedEntries.push(entries[i]);
							}
						}
						successCallback(cleanedEntries);
					},
					function (err) { // error
						if (errorCallback) {
							errorCallback(err);
						}
					}
				);
			}, function(err) {
				errorCallback(err);
			});
		};

		$(function() {
			var append_files = function(parent_el, path) {
				read_files(path, function(files) {
					var children = _.map(files, function(file) {
						var list_item = $("<li />");
						var list_link = $("<a />")	.attr("href", "javascript:void(0)")
													.text(file.name)
													.appendTo(list_item);
						if(file.type === "file") {
							var span = $("<span />").html("&nbsp;").addClass("expansion").prependTo(list_item);
							list_item.addClass("file");
						} else {
							var span = $("<span />").addClass("expansion").text("+").prependTo(list_item);
							list_item.addClass("collapsed");
							var children = $("<ul />").appendTo(list_item);
							list_link.click(function() {
								if(list_item.is(".collapsed")) {
									list_item.addClass("expanded")
											.removeClass("collapsed");
									span.text("-");
									append_files(children, file.path);
								} else {
									list_item.removeClass("expanded")
											.addClass("collapsed");
									children.children().remove();
									span.text("+");
								}
							});
							list_item.addClass("directory");
						}
						return list_item;
					});
					_.forEach(children, function(child) {
						parent_el.append(child);
					});
				}, function(err) {
					var child = $("<li />").text("Error").addClass("error");
					parent_el.append(child);
				});
			};
			append_files($("div#files"), "/");
		});

	</script>
	<style type="text/css">
		body {
			font-family: "Futura", "helvetica", "Arial", "verdana", sans-serif;
			font-weight: lighter;
		}
		ul {
			margin: 0px;
		}
		li {
			list-style-type: none;
		}
		li.error {
			color: red;
		}
		a {
			text-decoration: none;
			color: #444;
		}
		a:hover {
			color: #222;
			text-decoration: underline;
		}
		span.expansion {
			width: 17px;
			float: left;
			color: #AAA;
			text-align: center;
		}
		body {
			background-color: #EEE;
		}
		div#files {
			background-color: #FFF;
			border: 1px solid black;
			border-radius: 5px;
			padding: 20px;
		}
	</style>
  </head>
  <body>
	  <div id="files" />
  </body>
</html>
