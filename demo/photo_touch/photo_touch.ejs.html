<!DOCTYPE html>
<html lang="en">
  <head>
    <title>cjs</title>
	<meta name="viewport" content="width = device-width, user-scalable=no, initial-scale=1">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	
	<script type="text/javascript" src="../jquery.js"></script>
	<script type="text/javascript" src="../underscore-min.js"></script>
	<%- include(cjs_inc.main) %>
	<script type="text/javascript">
		var get_updater = function(do_update, update_interval) {
			update_interval = update_interval || 20;
			var up_timeout = undefined;
			var updater = function() {
				if(_.isUndefined(up_timeout)) {
					up_timeout = window.setTimeout(function() {
						do_update.apply(this, arguments);
						up_timeout = undefined;
					}, update_interval);
				}
			};
			return updater;
		};

		$.fn.touchmove = function() {
			$.each(this, function() {
				var $img = $(this);
				var $div = $img.wrap("<div class='img' />").parent();
				var $slider = $("<div class='slider' />").appendTo($div).hide();

				$div.css("position", "absolute");

				var position = {
					scale: cjs(1)
					, rotation: cjs(0)
					, translatex: cjs(0)
					, translatey: cjs(0)
					, originx: cjs(0)
					, originy: cjs(0)
				};
				var manip = {
					opacity: cjs(1)
				};

				var percent_opacity = cjs(function() {
					return Math.round(manip.opacity.get()*100);
				});

				cjs.binding.css($div[0], "opacity", percent_opacity.div(100), 5);
				cjs.binding.css($slider[0], "top", cjs(function() {
										return (100 - percent_opacity.get()) + "%"
									}), 5);
				cjs.binding.text($slider[0], percent_opacity);

				var transform_css = cjs(function() {
					return ""
						+ " translate("+position.translatex.get()+"px,"+position.translatey.get()+"px)"
						+ " rotate("+position.rotation.get()+"rad)"
						+ " scale("+position.scale.get()+")"
						;
				});
				var origin_css = cjs(function() {
					return position.originx.get() + "px " + position.originy.get() + "px";
				});
				cjs.binding.css($div[0], "-webkit-transform", transform_css);
				cjs.binding.css($div[0], "-webkit-transform-origin", origin_css);

				var state = {
					touches: []
					, start_position: {
						scale: position.scale.get()
						, rotation: position.rotation.get()
						, translatex: position.translatex.get()
						, translatey: position.translatey.get()
						, originx: position.originx.get()
						, originy: position.originy.get()
					}
					, manip: {
						opacity: manip.opacity.get()
					}
				};

				var my_touches = [];

				var get_touch_with_id = function(id) {
					for(var i = 0; i<state.touches.length; i++) {
						var touch = state.touches[i];
						if(touch.identifier === id) {
							return touch;
						}
					}
					return null;
				};
				var get_touch_distance = function(t1, t2) {
					var t1x = t1.clientX, t1y = t1.clientY
						, t2x = t2.clientX, t2y = t2.clientY;
					return Math.sqrt(Math.pow(t1x-t2x, 2) + Math.pow(t1y-t2y, 2));
				};
				var get_touch_center = function(t1, t2) {
					var t1x = t1.clientX, t1y = t1.clientY
						, t2x = t2.clientX, t2y = t2.clientY;
					return {x: (t1x+t2x)/2.0, y: (t1y+ t2y)/2.0};
				};
				var get_touch_angle = function(t1, t2) {
					var t1x = t1.clientX, t1y = t1.clientY
						, t2x = t2.clientX, t2y = t2.clientY;
					var dx = t2x - t1x, dy = t2y - t1y;
					return Math.atan2(dy, dx);
				};

				$img.on("touchstart", function(event) {
					var e = event.originalEvent; e.preventDefault(); e.stopPropagation(); e.cancelBubble=true;e.returnValue = false;
					$div.parent().append($div);

					state.touches = _.compact(_.map(e.touches, function(t) {
														if(t.target !== $img[0]) { return false; }
														else { return _.clone(t); }
													}));
					state.start_position = {
						scale: position.scale.get()
						, rotation: position.rotation.get()
						, translatex: position.translatex.get()
						, translatey: position.translatey.get()
						, originx: position.originx.get()
						, originy: position.originy.get()
					};
					state.manip =  {
						opacity: manip.opacity.get()
					};

					if(state.touches.length < 2) {
						$slider.hide();
					} else {
						$slider.show();
					}
					return false;
				});
				$img.on("touchend", function(event) {
					var e = event.originalEvent; e.preventDefault(); e.stopPropagation(); e.cancelBubble=true;e.returnValue = false;

					state.touches = _.compact(_.map(e.touches, function(t) {
														if(t.target !== $img[0]) { return false; }
														else { return _.clone(t); }
													}));
					state.start_position = {
						scale: position.scale.get()
						, rotation: position.rotation.get()
						, translatex: position.translatex.get()
						, translatey: position.translatey.get()
						, originx: position.originx.get()
						, originy: position.originy.get()
					};
					state.manip =  {
						opacity: manip.opacity.get()
					};
					
					if(state.touches.length < 2) {
						$slider.hide();
					} else {
						$slider.show();
					}
					return false;
				});


				$img.on("touchmove", function(event) {
					var e = event.originalEvent; e.preventDefault(); e.stopPropagation(); e.cancelBubble=true;e.returnValue = false;

					var touches = _.compact(_.map(e.touches, function(touch) {
														var orig_touch = get_touch_with_id(touch.identifier);
														if(orig_touch) {
															return {from: orig_touch, to: touch};
														} else { return false; }
													}));

					if(touches.length === 1) {
						var touch = touches[0];
						var dx = touch.to.clientX - touch.from.clientX;
						var dy = touch.to.clientY - touch.from.clientY;

						position.translatex.set(state.start_position.translatex + dx);
						position.translatey.set(state.start_position.translatey + dy);
					} else if(touches.length >= 2) {
						var from_distance = get_touch_distance(touches[0].from, touches[1].from);
						var to_distance = get_touch_distance(touches[0].to, touches[1].to);
						var from_angle = get_touch_angle(touches[0].from, touches[1].from);
						var to_angle = get_touch_angle(touches[0].to, touches[1].to);
						var from_pos = get_touch_center(touches[0].from, touches[1].from);
						var to_pos = get_touch_center(touches[0].to, touches[1].to);

						var scale_diff = to_distance / from_distance;
						var angle_distance = (to_angle - from_angle);

						position.scale.set(state.start_position.scale  * scale_diff);
						position.rotation.set(state.start_position.rotation + angle_distance);
						position.translatex.set(state.start_position.translatex + to_pos.x - from_pos.x);
						position.translatey.set(state.start_position.translatey + to_pos.y - from_pos.y);

						position.originx.set(to_pos.x - position.translatex.get());
						position.originy.set(to_pos.y - position.translatey.get());

						if(touches.length === 3) {
							var angle = get_touch_angle(touches[2].to, touches[2].from);
							var distance = get_touch_distance(touches[2].to, touches[2].from);
							var pic_angle = position.rotation.get();
							var multiplier = Math.sin(angle - pic_angle);
							var actual_distance = distance * multiplier;
							var scaled_slider_size = $img.height() * position.scale.get();
							var percentage_diff = (actual_distance / scaled_slider_size) + state.manip.opacity;
							percentage_diff = Math.max(0.1, Math.min(1, percentage_diff));
							manip.opacity.set(percentage_diff);
						}
					}
					return false;
				});
			});
		};
		$(function() {
			$(".pic").touchmove();
		});
	</script>
	<style type="text/css">
		html {
			width: 100%;
			height: 100%;
		}
		body {
			margin: 0px;
			overflow: hidden;
			width: 100%;
			height: 100%;
		}
		img {
			border: 1px solid #333;
			border-radius: 3px;
			box-shadow: 0px 0px 25px #333;
			-webkit-transition: all 0.05s ease-out;
		}
		div.img {
			-webkit-transition: all 0.05s ease-out;
		}
		div#container {
			width: 100%;
			height: 100%;
			background-image: url('noise.png');
			background-image: -webkit-gradient(linear, left top, right bottom, color-stop(0, #FFF), color-stop(1, #777));
		}
		div.slider {
			width: 40px;
			height: 70px;
			background-color: red;
			position: absolute;
			left: 100%;
			-webkit-transform: translate(-45px, -20px);
			pointer-events: none;
			border-radius: 30px;
			box-shadow: 0 0 25px rgba(255, 0, 0, 1);
			opacity: 0.8;
			text-align: center;
			font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
			font-weight: 300;
			color: white;
			vertical-align: middle;
			padding-top: 10px;
		}
	</style>
  </head>
  <body>
	  <div id="container">
		  <img width="500px" class="pic" src="pic1.jpeg" />
		  <img width="500px" class="pic" src="pic2.jpeg" />
		  <img width="500px" class="pic" src="pic3.jpeg" />
		  <!--
		  <img width="500px" class="pic" src="pic4.jpeg" />
		  <img width="500px" class="pic" src="pic5.jpeg" />
		  <img width="500px" class="pic" src="pic6.jpeg" />
		  -->
	  </div>
  </body>
</html>
