<!DOCTYPE html>
<html lang="en">
  <head>
    <title>cjs</title>
	<script type="text/javascript" src="../jquery.js"></script>
	<script type="text/javascript" src="../underscore-min.js"></script>
	<%- include(cjs_inc.main) %>
	<script type="text/javascript">
		$.get_plot = function(data) {

			var big_fsm = cjs	.fsm()
								.add_state("init")
								.add_state("idle")
								.add_state("dragging")
								.add_transition(cjs.on("mouseup", window), "idle");
			var scaling_dot = cjs();

			var scale_x = cjs(big_fsm, {
				"init": 1
				, "dragging": function() {
					var sdx = scaling_dot.get().x.get();
					var x = cjs.mouse.x.get() - offset.left;
					return sdx/x;
				}
				, "dragging>-idle": function() {
					return scale_x.get();
				}
			});
			var scale_y = cjs(big_fsm, {
				"init": 1
				, "dragging": function() {
					var sdy = scaling_dot.get().y.get();
					var y = offset.top - cjs.mouse.y.get() + 100;
					return sdy/y;
				}
				, "dragging>-idle": function() {
					return scale_x.get();
				}
			});
			var offset;

			$.get_dot = function(datum, x_axis, y_axis) {
				var dot = $("<div class='dot' />").css("left", datum.x)
												  .css("bottom", datum.y);
				var fsm = cjs	.fsm()
								.add_state("init")
								.add_state("idle")
								.add_state("dragging")
								.add_transition(cjs.on("mouseup", window), "idle");
				dot.on("mousedown", function(e) {
					if(e.shiftKey) {
						scaling_dot.set({x:x,y:y});
						big_fsm.set_state("dragging");
					} else {
						fsm.set_state("dragging");
						dot.parent().append(dot);
					}
					e.preventDefault();
					e.stopPropagation();
				});

				var x = cjs(fsm, {
					"init": datum.x
					, "dragging": function() {
						return cx.get() * scale_x.get();
					}
					, "dragging>-idle": function() {
						return x.get();
					}
				});
				var y = cjs(fsm, {
					"init": datum.y
					, "dragging": function() {
						return cy.get() * scale_y.get();
					}
					, "dragging>-idle": function() {
						return y.get();
					}
				});

				var cy = cjs(fsm, {
					"init,idle": function() {
						return y.get() / scale_y.get();
					}
					, "dragging": function() {
						return offset.top - cjs.mouse.y.get() + 100;
					}
					, "dragging>-idle": function() { return cy.get(); }
				});
				var cx = cjs(fsm, {
					"init,idle": function() {
						return x.get() / scale_x.get();
					}
					, "dragging": function() {
						return cjs.mouse.x.get() - offset.left;
					}
					, "dragging>-idle": function() { return cx.get(); }
				});
				cjs.binding.css(dot[0], "left", cx.unit("px"));
				cjs.binding.css(dot[0], "bottom", cy.unit("px"));
				cjs.binding.class(dot[0], fsm.state, "dot");
				
				return dot;
			};
			$.get_axis = function(from, to) {
				from = from || 0;
				to = to || 100;
				var axis = $("<div class='axis' />");
				var from = $("<span class='range range_from' />").appendTo(axis).text(from);
				var to = $("<span class='range range_to' />").appendTo(axis).text(to);
				return axis;
			};
			$.get_x_axis = function(f, t) {
				var axis = $.get_axis(f, t).addClass("x_axis");
				var fsm = cjs	.fsm()
								.add_state("init")
								.add_transition(cjs.on("mousedown", axis[0]), "dragging")
								.add_state("idle")
								.add_transition(cjs.on("mousedown", axis[0]), "dragging")
								.add_state("dragging")
								.add_transition(cjs.on("mouseup", window), "idle");
				var cy = cjs(fsm, {
					"init": function() {
						return -100;
					}
					, "dragging": function() {
						return offset.top - cjs.mouse.y.get();
					}
					, "dragging>-idle": function() { return cy.get(); }
				});
				var cx = cjs(fsm, {
					"init": function() {
						return "";
					}
					, "dragging": function() {
						return cjs.mouse.x.get() - offset.left-50;
					}
					, "dragging>-idle": function() { return cx.get(); }
				});


				cjs.binding.css(axis[0], "left", cx.unit("px"));
				cjs.binding.css(axis[0], "top", cy.mul(-1).unit("px"));
				axis.on("mousedown", function(e){e.preventDefault();e.stopPropagation();});

				var from = cjs(function() {
					return scale_x.get() * cx.get();
				});
				var to = cjs(function() {
					return scale_x.get() * (100+cx.get());
				});
				cjs.binding.text($("span.range_from", axis)[0], from.round());
				cjs.binding.text($("span.range_to", axis)[0], to.round());
				cjs.binding.class(axis[0], "axis x_axis", fsm.state);
				return axis;
			};
			$.get_y_axis = function(f, t) {
				var axis = $.get_axis(f, t).addClass("y_axis");
				var fsm = cjs	.fsm()
								.add_state("init")
								.add_transition(cjs.on("mousedown", axis[0]), "dragging")
								.add_state("idle")
								.add_transition(cjs.on("mousedown", axis[0]), "dragging")
								.add_state("dragging")
								.add_transition(cjs.on("mouseup", window), "idle");
				var cy = cjs(fsm, {
					"init": function() {
						return f;
					}
					, "dragging": function() {
						return offset.top - cjs.mouse.y.get() + 50;
					}
					, "dragging>-idle": function() { return cy.get(); }
				});
				var cx = cjs(fsm, {
					"init": function() {
						return "";
					}
					, "dragging": function() {
						return cjs.mouse.x.get() - offset.left;
					}
					, "dragging>-idle": function() { return cx.get(); }
				});


				cjs.binding.css(axis[0], "left", cx.unit("px"));
				cjs.binding.css(axis[0], "top", cy.mul(-1).unit("px"));
				axis.on("mousedown", function(e){e.preventDefault();e.stopPropagation();});

				var from = cjs(function() {
					return scale_y.get() * cy.get();
				});
				var to = cjs(function() {
					return scale_y.get() * (100+cy.get());
				});
				cjs.binding.text($("span.range_from", axis)[0], from.round());
				cjs.binding.text($("span.range_to", axis)[0], to.round());
				cjs.binding.class(axis[0], "axis y_axis", fsm.state);
				return axis;
			};


			var plot = $("<div class='plot' />");
			cjs.binding.class(plot[0], "plot", big_fsm.state);
			window.setInterval(function() {
				offset = plot.offset();
			}, 500);

			var x_axis = $.get_x_axis(0,100);
			var y_axis = $.get_y_axis(0,100);
			var dots = _.map(data, function(datum) {
					return $.get_dot(datum, x_axis, y_axis);
				});
			plot.append(x_axis);
			plot.append(y_axis);
			_.forEach(dots, function(dot) {
				plot.append(dot);
			});
			return plot;
		};
		var data = [{x:5, y: 20}, {x: 20, y: 10}, {x:30, y:30}, {x:60, y:40}, {x: 65, y: 45}, {x: 70, y: 45}, {x: 63, y: 80}, {x: 68, y: 75}, {x: 80, y: 80}];
		$(function() {
			var plot = $.get_plot(data);
			$(document.body).append(plot);
		});
	</script>
	<style type="text/css">
		body {
			font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
			font-weight: 300;
		}
		.plot {
			position: relative;
			width: 100px;
			height: 100px;
			margin: auto;
			margin-top: 100px;
		}
		.x_axis {
			height: 2px;
			width: 100%;
			position: absolute;
			bottom: 0%;
			pointer: default;
		}
		.x_axis .range_from {
			position: relative;
			top: 5px;
			left: 5px;
		}
		.x_axis .range_to {
			float: right;
			position: relative;
			top: 5px;
			left: 0px;
		}
		.y_axis {
			width: 2px;
			height: 100%;
			pointer: default;
		}
		.y_axis .range_from {
			vertical-align: bottom;
			position: absolute;
			bottom: 0px;
			left: -50px;
			width: 45px;
			text-align: right;
		}
		.y_axis .range_to {
			position: absolute;
			left: -50px;
			width: 45px;
			text-align: right;
		}

		.range {
			font-size: 0.9em;
			color: #333;
			text-shadow: 0px 0px 1px #777;
			-webkit-transition-property: background-color, box-shadow, border, -webkit-transform, text-shadow;
			-webkit-transition-duration: 0.1s;
			-webkit-transition-timing-function: ease-in-out;
		}

		.axis {
			background-color: #333;
			position: absolute;
			box-shadow: 0px 0px 2px #999;
			-webkit-transition-property: background-color, box-shadow, border, -webkit-transform, text-shadow, opacity;
			-webkit-transition-duration: 0.1s;
			-webkit-transition-timing-function: ease-in-out;
		}

		.dot {
			width: 5px;
			height: 5px;
			border-radius: 100px;
			border: 1px solid black;
			position: absolute;
			box-shadow: 0px 0px 2px #333;
			background-color: #EEE;
			-webkit-transform: translate(-3px, 3px);
			-webkit-transition-property: background-color, box-shadow, border, -webkit-transform, opacity;
			-webkit-transition-duration: 0.1s;
			-webkit-transition-timing-function: ease-in-out;
		}

		.dot.dragging {
			box-shadow: 0px 0px 5px #F00;
			border: 3px solid red;
			background-color: red;
			-webkit-transform: translate(-5px, 5px);
		}

		.plot.dragging .dot {
			background-color: #4169E1;
			border: 1px solid #4169E1;
			box-shadow: 0px 0px 3px #4169E1;
		}
		.plot.dragging .axis {
			opacity: 0.85;
		}
		.plot.dragging .range {
			color: #4169E1;
			text-shadow: 0px 0px 2px #4169E1;
		}

		.axis.dragging {
			background-color: red;
			box-shadow: 0px 0px 5px #F00;
		}
		.axis.dragging .range {
			color: red;
			text-shadow 0px 0px 3px red;
		}
	</style>
  </head>
  <body>
  </body>
</html>
