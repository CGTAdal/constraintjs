<!DOCTYPE html>
<html lang="en">
	<head>
        <title>ConstraintJS Guide</title>
		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
		<link rel="stylesheet" href="style/stylesheet.css">
		<link rel="stylesheet" href="style/page_style.css">
		<link rel="icon" type="image/png" href="resources/cjs_logo_64.png" />
		<style type="text/css">
			.figure {
				text-align: center;
			}
			.figure img {
				margin: 0.7em;
				border: 1px solid #DDD;
				padding: 1em;
			}
			.caption {
				font-weight: bold;
				font-size: 0.85em;
			}
			.leftnav {
				margin-top: 25px;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<header class="keystone row">
				<div class="col-md-2">
					<a href="."><img id="cjs_logo" src="resources/cjs_logo_256.png" title="ConstraintJS"/></a>
				</div>
				<div class="col-md-10">
					<ul class="nav navbar-nav hidden-xs">
						<li>
							<a href=".">Home</a>
						</li>
						<li class="active">
							<a href="guide.html">Documentation</a>
						</li>
						<li>
							<a href="api.html">API</a>
						</li>
					</ul>
				</div>
			</header>
			<div class="row">
				<div class="leftnav col-md-4">
					<ul class="nav nav-list">
						<li class="nav-header">Introduction</li>
						<li><a href="#what_is_cjs">What is ConstraintJS?</a></li>
						<li><a href="#where_use_cjs">Where can I use ConstraintJS?</a></li>
						<li><a href="#how_use_cjs">How do I use ConstraintJS?</a></li>
						
						<li class="nav-header">Variables</li>
						<li><a href="#cjs_variables">Creating CJS Variables</a></li>
						<li><a href="#variable_modifiers">Variable Modifiers</a></li>
						<li><a href="#invalidation">Variable Invalidation</a></li>
						<li><a href="#detecting_variable_changes">Detecting Variable Changes</a></li>
						<li><a href="#linking_variables_to_dom">Linking Variables to the DOM</a></li>
						<li><a href="#conditional">Conditional Variables</a></li>
						<li><a href="#arrays">Arrays</a></li>
						
						<li class="nav-header">States &amp; FSMs</li>
						<li><a href="#creating_fsms">Creating FSMs</a></li>
						<li><a href="#adding_states">Adding States</a></li>
						<li><a href="#transition_events">Transition Events</a></li>
						<li><a href="#adding_transitions">Switching States &amp; Adding Transitions</a></li>
						<li><a href="#fsm_chaining">Chaining</a></li>
						<li><a href="#fsm_constraints">FSM Constraints</a></li>
						
						<li class="nav-header">Templates</li>
						<li><a href="#templates_overview">Template Overview</a></li>
						<li><a href="#using_templates">Using Templates</a></li>
						<li><a href="#templates_variables">Variables</a></li>
						<li><a href="#templates_conditionals">Conditionals</a></li>
						<li><a href="#templates_states">States</a></li>
						<li><a href="#templates_loops">Loops</a></li>
					</ul>
				</div>
				<div class="col-md-8">
					<h1>ConstraintJS Guide <small>for ConstraintJS v0.9</small></h1>
					<p>This guide will get you up and running with ConstraintJS.</p>
					<p>Please mail any corrections or suggestions to <a href="mailto:swloney@gmail.com">Stephen Oney</a>.</p>
					
					<h2>Introduction</h2>
					
					<!-- ================================================================================ -->
					<h3 id="what_is_cjs">What is ConstraintJS?</h3>
					<p>ConstraintJS is a JavaScript library for creating <em>constraints</em> &mdash; relationships between variables that are declared once and automatically maintained. An example of a simple constraint is: <code>y</code> is <em>always</em> <code>x + 1</code>. Setting <code>var y = x + 1</code> won't work because as soon as <code>x</code> changes, <code>y</code> would be out of date. We'd have to update <code>x</code> every time <code>a</code> changed.</p>
					
					<p>With ConstraintJS, this relationship would be expressed as <code>var y = x.add(1)</code>. Now, whenever <code>x</code> changes, <code>y</code> changes along with it. ConstraintJS allows constraints to be declared between variables, DOM attributes, CSS properties, and more.</p>
					
					<p>Unlike JavaScript <a href="http://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller" target="_blank">MVC</a> frameworks (e.g. <a href="http://emberjs.com/" target="_blank">Ember.js</a> and <a href="http://backbonejs.org/" target="_blank">Backbone.JS</a>) ConstraintJS does not impose any required structure on your code and allows more kinds of constraints to be declared.</p>
					
					<!-- ================================================================================ -->
					<h3 id="where_use_cjs">Where can I use ConstraintJS?</h3>
					
					<p>ConstraintJS works in both client-side browser JavaScript (e.g. Chrome, IE, & Firefox) and server-side JavaScript (e.g. Node.JS) It can be integrated into any codebase; your code could use 99% standard JavaScript and a single ConstdraintJS constraint.</p>
					
					<!-- ================================================================================ -->
					<h3 id="how_use_cjs">How do I use ConstraintJS?</h3>
					
					<p>The easiest way to get started using ConstraintJS is to download and unzip <a href="builds/ConstraintJS-0.9.0.zip">the latest package (v0.9 as of this writing.)</a> ConstraintJS can be included in client-side code:</p>
					<pre class="prettyprint lang-html">&lt;script src="/PATH/TO/cjs.min.js" type="text/javascript"&gt;&lt;/script&gt;</pre>
					<p>or server-side code:</p>
					<pre class="prettyprint lang-js">var cjs = require("PATH/TO/cjs");</pre>

					<p>All of ConstraintJS's functionality is accessed through the global <code class="prettyprint lang-js">cjs</code> object. The <code class="prettyprint lang-js">cjs.noConflict()</code> function allows developers to change the name of the ConstraintJS global object if there is a name conflict. For example:</p>
					
					<pre class="prettyprint lang-js">var ConstraintJS = cjs.noConflict()</pre>
					
					<p>Places all of the ConstraitnJS functionality into the <code class="prettyprint lang-js">ConstraintJS</code> variable and resets the <code class="prettyprint lang-js">cjs</code> variable to its previous value.</p>
					
					<h2>Variables</h2>
					
					<p>ConstraintJS uses <em>constrainable variables</em> &mdash; regular JavaScript variables with wrappers that allow constraints to be added to them.</p>
					
					<!-- ================================================================================ -->
					<h3 id="cjs_variables">Creating CJS Variables</h3>
					
					<p>Any JavaScript object or widget may be turned into a constrainable variable using the <code>cjs</code> function with the variable as a parameter. For example:
					
					<pre class="prettyprint">var x = cjs(1); // x &lt;- 1</pre>
					
					<p>Creates <code>x</code>, a constrainable variable whose value is <code>1</code>. The <code>.get()</code> function fetches the value of a constrainable variable and <code>.set(value)</code> sets its value:</p>

<pre class="prettyprint lang-js">
x.get();  // = 1
x.set(2); // x &lt;- 2
x.get();  // = 2
</pre>
						
					<p>Dynamically computed variables can be created by passing a function as the parameter:</p>
		
<pre class="prettyprint lang-js">
var y = cjs(function() {
                return x.get() + 1;   // y &lt;- x + 1
        });
        
x.get();  // = 2
y.get();  // = 3
x.set(9); // x &lt;- 9
y.get();  // = 10
</pre>
									
					<!-- ================================================================================ -->
					<h3 id="variable_modifiers">Variable Modifiers</h3>
					
					<p>Constrainable variables also have several built-in utility methods to create new dependent variables. For instance, the declaration of <code>y</code> above may seem cumbersome but the same thing can be achieved with: </p>
											
					<pre class="prettyprint">y = x.add(1);  // y &lt;- x + 1</pre>
						
					<p>In this case, <code>.add()</code> is a built-in function that creates a new constrainable variable. Other built-in functions include:</p>
					<ul>
                        <li><strong><code>.add(...)</code></strong> &mdash; take the sum</li>
						<li><strong><code>.sub(...)</code></strong> &mdash; take the difference</li>
						<li><strong><code>.mul(...)</code></strong> &mdash; take the product</li>
						<li><strong><code>.div(...)</code></strong> &mdash; take the quotient</li>
						<li><strong><code>.eq(x)</code></strong> &mdash; returns if the constraint variable <code> == x</code></li>
						<li><strong><code>.strictEq(x)</code></strong> &mdash; returns if the constraint variable <code> === x</code></li>
						<li><strong><code>.gt(x)</code></strong> &mdash; returns if the constraint variable <code> &gt; x</code></li>
						<li><strong><code>.ge(x)</code></strong> &mdash; returns if the constraint variable <code> &gt;= x</code></li>
						<li><strong><code>.lt(x)</code></strong> &mdash; returns if the constraint variable <code> &lt; x</code></li>
						<li><strong><code>.le(x)</code></strong> &mdash; returns if the constraint variable <code> &lt;= x</code></li>
						<li><strong><code>.round()</code></strong> &mdash; rounds the constraint variable to the nearest integer</li>
					</ul>
					
					
					<p>Custom constraint functions may also be created, as outlined in the "<a href="#constraint_mixins">Mixins</a> section.</p>

					<!-- ================================================================================ -->
					<h3 id="invalidation">Variable Invalidation</h3>
					<p>ConstraintJS automatically detects and manages <em>dependencies</em> (relationships) between constrainable variables. For instance, in the previous code snippet, a dependency from <code>x</code> to <code>y</code> was established, which we will illustrate conceptually with an arrow from variable x to y:</p>
						<div class="figure">
							<img src="guide/images/x_to_y_dependency.png" />
							<div class="caption"><code>y</code> depends on <code>x</code> (think of <code>x</code>'s value as flowing to <code>y</code>)</div>
						</div>
					
					<p>This dependency lets ConstraintJS know that whenever <code>x</code> changes, ConstraintJS knows that <code>y</code> has also changed. When we call:</p>
					<pre>x.set(9)</pre>
					<p><code>y</code> and any other variables that depend on <code>x</code> are marked as <em>invalid</em>, which means that their values needs to be recomputed:</p>
					
						<div class="figure">
							<img src="guide/images/x_to_invalid_y.png" />
							<div class="caption"><code>y</code> is invalidated after <code>x</code> changes</div>
						</div>					
					<p>To invalidate a variable manually, call it's <code>.invalidate</code> function.</p>
					
					<p>ConstraintJS uses a "pull model" for constraints, meaning that <code>y</code> is not recomputed only when its value is requested; not as soon as it's invalidated. When <code>y</code>'s value is <strong>not</strong> invalid, ConstraintJS caches its value so that it isn't recomputed unnecessarily. To illustrate, consider the following snippet of code, where although <code>x</code>'s value changes three times, <code>y</code>'s value is only recomputed twice:</p>
<pre class="prettyprint lang-js">
var y = cjs(function() {
                console.log("recomputing y");
                return x.get() + 1;   // y &lt;- x + 1
        });
        
x.get();   // = 2
y.get();   // = 3, "recomputing y" printed
y.get();   // = 3, nothing printed
x.set(9);  // x &lt;- 9
x.set(10); // x &lt;- 10
x.set(11); // x &lt;- 11
y.get();   // = 12, "recomputing y" printed
</pre>
					<p>For more details on the exact algorithm, read <a href="guide/integrating_pointer_variables_paper.pdf">this paper</a>.</p>
					<!--Add example of depending on a slider's value?-->
					
					<!-- ================================================================================ -->
					<h3 id="detecting_variable_changes">Detecting Variable Changes</h3>
					<p>The previous sections have gone over some basic ways to create constrainable variables. Next, we're going to go over some ways to use them. The simplest way is with the <code>c.onChange(callback, [maxInterval])</code> method, which calls <code>callback</code> whenever <code>c</code> changes:</p>
					
<pre class="prettyprint">
var c = cjs(1);
c.onChange(function(new_val, old_val) {
	console.log("was :" + old_val +", now: " + new_val);
}); // was: null, now: 1

c.set(2); // was: 1, now: 2
</pre>
					<p><code>.onChange</code> accepts two parameters: <code>callback</code> &mdash; the callback function &mdash; and <code>maxInterval</code> &mdash; the minimum millisecond delay between calls to <code>callback</code>.</p>
					
					<p><code>.onChange(callback)</code> hooks can be removed with the <code>.offChange(callback)</code> function.</p>
					
					<!-- ================================================================================ -->
					<h3 id="linking_variables_to_dom">Linking Variables to the DOM</h3>
					
					<p>CSS and DOM attributes may also be bound to variable values. First, select the elements to be modified using <code>cjs.$(selector)</code>. For instance:</p>

<pre class="prettyprint">
var selected = cjs.$(".selected");
</pre>
					<p>After the DOM elements are selected, there are several utility functions to modify their values:</p>
					
					<ul>
						<li><strong><code>.class(value)</code></strong> &mdash; set the class name of a DOM object</li>
						<li><strong><code>.attr(attr_name,value)</code></strong> &mdash; set any attribute of the DOM obj.</li>
						<li><strong><code>.css(attr_name,value)</code></strong> &mdash; set a CSS attribute of the DOM obj.</li>
						<li><strong><code>.text(value)</code></strong> &mdash; set the text value of a DOM obj.</li>
						<li><strong><code>.val(text)</code></strong> &mdash; set the value of a text input obj.</li>
						<li><strong><code>.children(value)</code></strong> &mdash; set the child nodes of a DOM obj. value may be an array.</li>
					</ul>
					
					For example:
<pre class="prettyprint">
var bg_color = cjs("red");
selected.css("background-color", bg_color); // Everything with class selected now has a red background
bg_color.set("blue"); // Everything with class selected now has a blue background
</pre>


					<!-- ================================================================================ -->
					<h3 id="conditional">Conditional Variables</h3>
					<p>"Conditional" constrainable variables are like normal constraint variables, except their value is dependent on the value of some condition. To create a conditional constraint, pass in an object with a <code>condition</code> property:</p>
											
											
<pre class="prettyprint">
var z = cjs({   condition: x.gt(0)  // if x &gt; 0
              , value: x }          //     z &lt;- x
            {   condition: "else"   // else
              , value: x.mul(-1)}); //     z &lt;- x*-1
</pre>
					<p>To create a conditional constraint, pass in any number of parameters with <code>condition</code> and <code>value</code> properties. The last parameter may have a condition of <code>"else"</code>.</p>
					
					<!-- ================================================================================ -->
					<h3 id="arrays">Arrays</h3>
					<p>Constrainable variables with arrays as values are treated the same as normal constraint variables; <code>cjs([1,2,3])</code> returns a constrainable variable whose value is the array <code>[1,2,3]</code> Still, ConstraintJS has several functions for dealing with constraints involving arrays. The <code>.map()</code> function creates an array whose values depend on the values of a constraint based on another array. For instance:</p>
					
<pre class="prettyprint">var x = cjs([1,2,3]);
var y = x.map(function(val) {
                 return val + 1;
             });
y.toArray(); // = [2,3,4]</pre>
					
					<p>When the source array (<code>x</code>) changes, <code>.map()</code> computes the difference from the previous value in terms of items removed, items added, and items moved. If the value of <code>x</code> changes to <code>[3,4]</code>, then <code>y</code> should get the value <code>[4, 5]</code>. <code>.map()</code> will detect that 3 was already in the source array and so it only computes the mapped value for <code>4</code>. The same difference mechanism is used in the <code>.children()</code> method (described above in "Constraining DOM objects to variables") to avoid removing and re-adding DOM child nodes unnecessarily.</p>
					
					<p>Changes to the variable's value can be detected with <code>.onChange(callback)</code>, <a href="#detecting_variable_changes">just as before</a>, but ConstraintJS also includes <code>.onAdd(callback)</code>, <code>.onMove(callback)</code>, and <code>.onRemove(callback)</code> utility functions for detecting array changes. These hooks may be removed with <code>.offAdd(callback)</code>, <code>.offMove(callback)</code>, and <code>.offRemove(callback)</code> respectively.</p>

					
					<!-- ================================================================================ -->
					<!-- ================================================================================ -->
					<h2>States &amp; FSMs</h2>
					<p>Many applications are <em>state-oriented</em> &mdash; appearing and behaving differently in different states. ConstraintJS integrates <a href="http://en.wikipedia.org/wiki/Finite-state_machine" target="_blank">Finite-State Machines (FSMs.)</a></p>
					
					<h3 id="creating_fsms">Creating FSMs</h3>
					
					<p>A new FSM is created when <code>cjs.fsm()</code> is called:</p>
					
<pre class="prettyprint">
var my_fsm = cjs.fsm();
</pre>
					<p>creates an FSM called <code>my_fsm</code>.</p>

					
					<!-- ================================================================================ -->
					<h3 id="adding_states">Adding States</h3>
					
					<p>States may be added to an FSM with the <code>.add_state(state_name)</code> function:</p>
					
<pre class="prettyprint">
my_fsm.add_state("idle");
</pre>
					<p><code>.starts_at(state_name)</code> specifies the initial state of the FSM. <code>.add_state</code> returns the original FSM (<code>my_fsm</code> in the above example.)</p>
					
					
					<!-- ================================================================================ -->
					<h3 id="transition_events">Transition Events</h3>
					
					<p><em>Transition events</em> &mdash; or events on which transitions occur &mdash; are created with the <code>cjs.on(event_name, dom_element)</code> function. <code>event_name</code> is a <a href="http://en.wikipedia.org/wiki/DOM_events" target="_blank">standard JavaScript DOM event</a> and <code>dom_element</code> is the DOM element to which that event is occurring. For example: <code>cjs.on("mousedown", my_div)</code></p>
					
					<p><em>Guards</em> &mdash; conditions on which the transition event may occur may be added with <code>.guard(condition_func)</code>. For example: <code>cjs.on("mousedown", my_div).guard(function(event) { return false;})</code> would never fire because the guard always returns <code>false</code>.</p>
					
					<p>Transition events are functions that accept a parameter to perform the transition, allowing custom transition events to be created. For example, <code>cjs.on("mousedown", my_div)</code> is equivalent to:</p>
					
<pre class="prettyprint">
function(do_transition) {
	my_div.addEventListener("mousedown", do_transition);
}
</pre>
					
					<!-- ================================================================================ -->
					<h3 id="adding_transitions">Switching States &amp; Adding Transitions</h3>
					
					<p>Although states may be added manually with <code>.set_state(state_name)</code>, the encouraged way of transitioning between states is with <em>transitions</em> &mdash; pre-defined state changes that take place after some event. <code>fsm.add_transition(event, to_state)</code> adds a transition from the last state added to <code>to_state</code> (string) when the <code>event</code> transition event (described above) occurs:</p>

<pre class="prettyprint">
var my_fsm = cjs .fsm()
                 .add_state("idle");

my_fsm.add_transition(cjs.on("mouseover", block_a);
</pre>
					<p><code>.add_transition</code> returns the original FSM (<code>my_fsm</code> in the above example.)</p>

					<!-- ================================================================================ -->
					<h3 id="fsm_chaining">Chaining</h3>
					
					<p>ConstraintJS's FSM syntax is designed to support "chaining," a convention in JavaScript where an object property performs an operation on that object and returns the object back. For instance:</p>

<pre class="prettyprint">
var my_fsm = cjs.fsm()
                .add_state("idle")
                    .add_transition(cjs.on("mouseover", block_a)
                                    , "myhover")        
                .add_state("myhover")
                    .add_transition(cjs.on("mouseout", block_a)
                                    , "idle")
                .starts_at("idle");
</pre>
					
					<!-- ================================================================================ -->
					
					<h3 id="fsm_constraints">FSM Constraints</h3>
					
					<p>Constraint variables may depend on FSMs. To create an FSM-dependent constraint, pass the FSM as the first parameter to <code>cjs</code> and an object with states and their values as the second parameter:</p>
	
<pre class="prettyprint">
var color = cjs(my_fsm, {
               "idle":    "black", 
               "myhover": "yellow"
            });</pre>

					<!-- ================================================================================ -->
					<!-- ================================================================================ -->
					<h2>Templates</h2>
					
					
					<!-- ================================================================================ -->
					<h3 id="templates_overview">Template Overview</h3>

					<p>ConstraintJS also allows HTML templates to be declared in the syntax of <a href="http://handlebarsjs.com/" target="_blank">Handlebars.JS</a> or <a href="http://emberjs.com/" target="_blank">Ember</a> with values that update with the constraint variables. We extend the syntax of Handlebars by allowing states to be included in the template declaration. These templates accept snippets of HTML code with constraint variables that automatically update the values of parameters.</p>


					<!-- ================================================================================ -->
					<h3 id="using_templates">Using Templates</h3>
					<p>Templates are created with the <code>cjs.template(templ, env)</code> function. It has two parameters. <code>templ</code> is the template code as either a String or a link to an external template in the form of <code>#my_id</code> if there is an element declared as <code>&lt;script type="cjs/template" id="my_id"&gt;&lt;/script&gt;</code>. <code>env</code> is the set of variables to use as the environment. If no <code>env</code> variable is passed, <code>cjs.template()</code> returns a function that may be called to generate a template. <code>cjs.template()</code> otherwise returns a DOM element that may be added anywhere in the page.</p>

<pre class="prettyprint">
&lt;script id="greeting" type="cjs/template"&gt;
    &lt;div&gt;Hello {{firstname}} {{lastname}}&lt;/div&gt;
&lt;/script&gt;
//...

var fn = cjs("Mary")
    , ln = cjs("Parker");
cjs.template("#greeting"
             , {firstname: fn, lastname: ln});
             </pre>
             
					<!-- ================================================================================ -->
					<h3 id="templates_variables">Variables</h3>
					<p>Variables are specified using double curly braces (<code>{{x}}</code> or <code>{{y[0]}}</code> to return the first element of an array <code>y</code>)</p>
             
					<!-- ================================================================================ -->
					<h3 id="templates_conditionals">Conditionals</h3>
<pre class="prettyprint">
{{#if logged_in}}
    &lt;div&gt;Hello {{firstname}}
               {{lastname }}&lt;/div&gt;
{{#else}}
    &lt;a href="login"&gt;Log in&lt;/a&gt;
{{/if}}
</pre>
					<!-- ================================================================================ -->
					<h3 id="templates_states">States</h3>
<pre class="prettyprint">
{{#fsm selected_lang}}
	{{#state english}}
        &lt;div&gt;Hello {{firstname}}
                   {{lastname }}&lt;/div&gt;
	{{#state french}}
        &lt;div&gt;Bonjour {{firstname}}
                     {{lastname }}&lt;/div&gt;
{{/fsm}}
</pre>
					<!-- ================================================================================ -->
					<h3 id="templates_loops">Loops</h3>
<pre class="prettyprint">
{{#each people}}
   &lt;div&gt;Hello {{this.firstname}}
              {{this.lastname }}&lt;/div&gt;
{{/each}}
</pre>					
					<!-- ================================================================================ -->

					<h3 id="contribute">Contribute to ConstraintJS</h3>
					<p>We'd love to get your feedback and new people involved in the project! You can reach <a href="http://from.so/" target="_blank">me</a> at <a href="mailto:tsoney@gmail.com">tsoney@gmail.com</a>. The ConstraintJS GitHub page is at <a href="https://github.com/soney/ConstraintJS" target="_blank">https://github.com/soney/ConstraintJS</a>.</p>
		</div>
		<script src="builds/ConstraintJS-0.9.0/cjs.min.js"></script>
		<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
		<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
		<link href="resources/google-code-prettify/prettify.css" type="text/css" rel="stylesheet" />
		<script type="text/javascript" src="resources/google-code-prettify/prettify.js"></script>
		<script type="text/javascript">
			$(function() {
				prettyPrint();
			});
		</script>
		<script type="text/javascript">
		
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-30897901-1']);
		_gaq.push(['_trackPageview']);
		
		(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
		
		</script>
	</body>
</html>
